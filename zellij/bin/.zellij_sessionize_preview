#!/bin/sh

print_section() {
    # Blue, bold.
    printf "\033[1;34m%s\033[0m\n" "$1"
}

print_dim() {
    # Dim.
    printf "\033[2m%s\033[0m\n" "$1"
}

preview_active_session() {
    selection="$1"
    session_name=$(printf "%s" "$selection" | sed "s/ \\[active session\\]$//")

    tmp_dir="${TMPDIR:-/tmp}"
    tmp_file=$(mktemp "${tmp_dir}/zellij_sessionize_${session_name}.XXXXXX" 2>/dev/null || printf "%s/zellij_sessionize_%s.txt" "$tmp_dir" "$session_name")
    preview_lines="200"

    if zellij --session "$session_name" action dump-screen "$tmp_file" 2>/dev/null; then
        print_section "$session_name"
        if [ -s "$tmp_file" ]; then
            sed -n "1,${preview_lines}p" "$tmp_file" 2>/dev/null
        else
            print_dim "(empty pane output)"
        fi
    else
        printf "\033[31m%s\033[0m\n" "Unable to capture screen for session: $session_name"
    fi

    rm -f "$tmp_file" 2>/dev/null
}

is_git_repo() {
    dir="$1"
    git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1
}

preview_git_log() {
    dir="$1"
    # Keep it short; this runs frequently while moving in fzf.
    git -C "$dir" -c color.ui=always --no-pager log \
        --max-count=12 \
        --date=short \
        --decorate=short \
        --graph \
        --pretty=format:'%C(auto)%h %C(blue)%ad%C(reset) %C(yellow)%d%C(reset) %s %C(black)%an%C(reset)' \
        2>/dev/null
}

preview_git_status() {
    dir="$1"
    status=$(git -C "$dir" -c color.ui=always --no-pager status --short --branch --untracked-files=no 2>/dev/null | sed -n '1,80p')
    if [ -n "$status" ]; then
        printf "%s\n" "$status"
    else
        print_dim "(working tree clean)"
    fi
}

preview_listing() {
    dir="$1"
    # Keep this cheap; preview executes often.
    (cd "$dir" && ls -lah 2>/dev/null) | sed -n '1,160p'
}

preview_directory() {
    dir="$1"
    # Show full path without a "Directory:" label.
    print_section "$dir"

    if is_git_repo "$dir"; then
        preview_git_log "$dir"
        printf "\n"
        preview_git_status "$dir"
        return 0
    fi

    preview_listing "$dir"
}

selection="$1"

if [ -z "$selection" ]; then
    exit 0
fi

if printf "%s" "$selection" | grep -q " \\[active session\\]$"; then
    preview_active_session "$selection"
    exit 0
fi

if [ -d "$selection" ]; then
    preview_directory "$selection"
    exit 0
fi

print_dim "(no preview)"
