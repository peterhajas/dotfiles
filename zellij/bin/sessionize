#!/bin/sh

if [ -n "$ZELLIJ" ]; then
    zellij action launch-or-focus-plugin session-manager --floating --move-to-focused-tab
    exit 0
fi

# Directories to search (edit these as needed)
SEARCH_DIRS="
$HOME
$HOME/src
"

# Function to kill any existing "zellij attach SESSION_NAME" processes
kill_existing_attach_processes() {
    session_name="$1"
    # Find and kill any processes matching "zellij attach SESSION_NAME"
    pkill -f "zellij attach $session_name" 2>/dev/null || true
}

# Function to get the appropriate layout for a session
get_layout() {
    session_name="$1"
    layout_dir="$HOME/.config/zellij/layouts"

    # First try session-specific layout
    if [ -f "$layout_dir/$session_name.kdl" ]; then
        echo "$session_name"
    else
        # Fall back to phajas layout
        echo "phajas"
    fi
}

set_terminal_title() {
    session_name="$1"
    [ -n "$session_name" ] && printf '\033]0;zellij: %s\a' "$session_name"
}

# Get existing zellij sessions with visual indicator
SESSIONS=""
if zellij list-sessions >/dev/null 2>&1; then
    SESSIONS=$(zellij list-sessions --no-formatting --short 2>/dev/null | grep -v "^$" | awk '{print $1 " [active session]"}')
fi

# Pre-defined session names (no associated directories)
PREDEFINED_SESSIONS="sysmon
kanata
claude
codex"

# Filter out predefined sessions that are already active
ACTIVE_SESSION_NAMES=$(echo "$SESSIONS" | sed 's/ \[active session\]//')
FILTERED_PREDEFINED=""
for session in sysmon kanata claude codex; do
    if ! echo "$ACTIVE_SESSION_NAMES" | grep -q "^$session$"; then
        FILTERED_PREDEFINED="$FILTERED_PREDEFINED$session
"
    fi
done
PREDEFINED_SESSIONS="$FILTERED_PREDEFINED"

# Find directories at depth 1 in each search directory
DIRS=""
for search_dir in $SEARCH_DIRS; do
    if [ -d "$search_dir" ]; then
        DIRS="$DIRS$(find "$search_dir" -maxdepth 1 -type d -not -name ".*" | grep -v "^$search_dir$")
"
    fi
done

# Combine sessions (first), predefined sessions, and directories
ALL_OPTIONS="$SESSIONS
$PREDEFINED_SESSIONS
$DIRS"

RESULT=$(echo "$ALL_OPTIONS" | grep -v '^$' | fzf --prompt="Session: " --print-query --expect=ctrl-n)

if [ -z "$RESULT" ]; then
    exit 0
fi

# fzf outputs: key pressed, query, selection
KEY=$(echo "$RESULT" | sed -n '1p')
QUERY=$(echo "$RESULT" | sed -n '2p')
SELECTION=$(echo "$RESULT" | sed -n '3p')

# If Ctrl+N was pressed or no selection was made, create new session with query name
if [ "$KEY" = "ctrl-n" ] || [ -z "$SELECTION" ]; then
    SESSION_NAME="$QUERY"
    if [ -z "$SESSION_NAME" ]; then
        exit 0
    fi
    LAYOUT=$(get_layout "$SESSION_NAME")

    # Check if session already exists
    if zellij list-sessions --no-formatting --short 2>/dev/null | grep -q "^$SESSION_NAME$"; then
        # Session exists, attach to it
        if [ -n "$ZELLIJ" ]; then
            # Can't switch sessions from within Zellij, do nothing
            exit 0
        else
            kill_existing_attach_processes "$SESSION_NAME"
            set_terminal_title "$SESSION_NAME"
            zellij attach "$SESSION_NAME"
        fi
    else
        # Session doesn't exist, create it
        if [ -n "$ZELLIJ" ]; then
            zellij action new-session --layout "$LAYOUT" --name "$SESSION_NAME"
        else
            set_terminal_title "$SESSION_NAME"
            zellij --new-session-with-layout "$LAYOUT" --session "$SESSION_NAME"
        fi
    fi
    exit 0
fi

# Handle existing session selection
if echo "$SELECTION" | grep -q "\[active session\]"; then
    SESSION_NAME=$(echo "$SELECTION" | sed 's/ \[active session\]//')
    if [ -n "$ZELLIJ" ]; then
        # Can't switch sessions from within Zellij, do nothing
        exit 0
    else
        kill_existing_attach_processes "$SESSION_NAME"
        set_terminal_title "$SESSION_NAME"
        zellij attach "$SESSION_NAME"
    fi
    exit 0
fi

# Handle predefined session selection
if echo "$PREDEFINED_SESSIONS" | grep -q "^$SELECTION$"; then
    SESSION_NAME="$SELECTION"
    LAYOUT=$(get_layout "$SESSION_NAME")

    # Check if session already exists
    if zellij list-sessions --no-formatting --short 2>/dev/null | grep -q "^$SESSION_NAME$"; then
        # Session exists, attach to it
        if [ -n "$ZELLIJ" ]; then
            # Can't switch sessions from within Zellij, do nothing
            exit 0
        else
            kill_existing_attach_processes "$SESSION_NAME"
            set_terminal_title "$SESSION_NAME"
            zellij attach "$SESSION_NAME"
        fi
    else
        # Session doesn't exist, create it
        if [ -n "$ZELLIJ" ]; then
            zellij action new-session --layout "$LAYOUT" --name "$SESSION_NAME"
        else
            set_terminal_title "$SESSION_NAME"
            zellij --new-session-with-layout "$LAYOUT" --session "$SESSION_NAME"
        fi
    fi
    exit 0
fi

# Handle directory choice
DIR="$SELECTION"
SESSION_NAME=$(basename "$DIR")

# Check if session exists
if zellij list-sessions --no-formatting --short 2>/dev/null | grep -q "^$SESSION_NAME$"; then
    # Session exists, attach to it
    if [ -n "$ZELLIJ" ]; then
        # Can't switch sessions from within Zellij, do nothing
        exit 0
    else
        kill_existing_attach_processes "$SESSION_NAME"
        set_terminal_title "$SESSION_NAME"
        zellij attach "$SESSION_NAME"
    fi
else
    # Session doesn't exist
    if [ -n "$ZELLIJ" ]; then
        # Inside Zellij: just switch (do nothing if session doesn't exist)
        exit 0
    else
        # Outside Zellij: create new session
        LAYOUT=$(get_layout "$SESSION_NAME")
        cd "$DIR" && set_terminal_title "$SESSION_NAME" && zellij --new-session-with-layout "$LAYOUT" --session "$SESSION_NAME"
    fi
fi
