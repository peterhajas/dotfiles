#!/bin/sh

# Directories to search (edit these as needed)
SEARCH_DIRS="
$HOME
$HOME/src
"

# Get existing zellij sessions with visual indicator
SESSIONS=""
if zellij list-sessions >/dev/null 2>&1; then
    SESSIONS=$(zellij list-sessions --no-formatting --short 2>/dev/null | grep -v "^$" | awk '{print $1 " [active session]"}')
fi

# Find directories at depth 1 in each search directory
DIRS=""
for search_dir in $SEARCH_DIRS; do
    if [ -d "$search_dir" ]; then
        DIRS="$DIRS$(find "$search_dir" -maxdepth 1 -type d -not -name ".*" | grep -v "^$search_dir$")
"
    fi
done

# Combine sessions (first) and directories
ALL_OPTIONS="$SESSIONS
$DIRS"

RESULT=$(echo "$ALL_OPTIONS" | grep -v '^$' | fzf --prompt="Session: " --print-query --expect=ctrl-n)

if [ -z "$RESULT" ]; then
    exit 0
fi

# fzf outputs: key pressed, query, selection
KEY=$(echo "$RESULT" | sed -n '1p')
QUERY=$(echo "$RESULT" | sed -n '2p')
SELECTION=$(echo "$RESULT" | sed -n '3p')

# If Ctrl+N was pressed or no selection was made, create new session with query name
if [ "$KEY" = "ctrl-n" ] || [ -z "$SELECTION" ]; then
    SESSION_NAME="$QUERY"
    if [ -z "$SESSION_NAME" ]; then
        exit 0
    fi
    # Zellij doesn't support creating detached sessions, so we use 'action'
    if [ -n "$ZELLIJ" ]; then
        zellij action new-tab --name "$SESSION_NAME"
    else
        zellij --session "$SESSION_NAME"
    fi
    exit 0
fi

# Handle existing session selection
if echo "$SELECTION" | grep -q "\[active session\]"; then
    SESSION_NAME=$(echo "$SELECTION" | sed 's/ \[active session\]//')
    if [ -n "$ZELLIJ" ]; then
        # Switch to existing session using action
        zellij action switch-session "$SESSION_NAME"
    else
        zellij attach "$SESSION_NAME"
    fi
    exit 0
fi

# Handle directory choice
DIR="$SELECTION"
SESSION_NAME=$(basename "$DIR")

# Check if session exists
if zellij list-sessions --no-formatting --short 2>/dev/null | grep -q "^$SESSION_NAME"; then
    if [ -n "$ZELLIJ" ]; then
        zellij action switch-session "$SESSION_NAME"
    else
        zellij attach "$SESSION_NAME"
    fi
else
    if [ -n "$ZELLIJ" ]; then
        # Create new tab in current session with the directory
        zellij action new-tab --layout default --cwd "$DIR" --name "$SESSION_NAME"
    else
        # Create new session
        cd "$DIR" && zellij --session "$SESSION_NAME"
    fi
fi
