#!/usr/bin/env python3

import os
import re
import sys

def get_wiki_path():
    wiki_path = os.environ.get('TIDDLYWIKI_WIKI_PATH')

    if not wiki_path:
        print("Error: TIDDLYWIKI_WIKI_PATH environment variable is not set", file=sys.stderr)
        sys.exit(1)

    # Expand ~ to home directory
    wiki_path = os.path.expanduser(wiki_path)

    if not os.path.exists(wiki_path):
        print(f"Error: Wiki path does not exist: {wiki_path}", file=sys.stderr)
        sys.exit(1)

    return wiki_path

def load_all_tiddlers(wiki_path):
    import json

    with open(wiki_path, 'r', encoding='utf-8') as f:
        content = f.read()

    # Find all tiddlywiki-tiddler-store script tags
    pattern = r'<script class="tiddlywiki-tiddler-store" type="application/json">\s*(\[.*?\])\s*</script>'
    matches = re.finditer(pattern, content, re.DOTALL)

    all_tiddlers = []

    # Collect tiddlers from all stores (earliest to latest)
    for match in matches:
        tiddlers_json = match.group(1)
        tiddlers = json.loads(tiddlers_json)
        all_tiddlers.extend(tiddlers)

    if not all_tiddlers:
        print("Error: Could not find any tiddlers in wiki", file=sys.stderr)
        sys.exit(1)

    return all_tiddlers

def list_tiddlers(wiki_path):
    all_tiddlers = load_all_tiddlers(wiki_path)

    # Collect all titles and sort alphabetically
    titles = [tiddler['title'] for tiddler in all_tiddlers if 'title' in tiddler]
    titles.sort()

    # Print all tiddler titles
    for title in titles:
        print(title)

def cat_tiddler(wiki_path, tiddler_title):
    all_tiddlers = load_all_tiddlers(wiki_path)

    # Find the tiddler with matching title
    tiddler = None
    for t in all_tiddlers:
        if t.get('title') == tiddler_title:
            tiddler = t
            break

    if not tiddler:
        print(f"Error: Tiddler '{tiddler_title}' not found", file=sys.stderr)
        sys.exit(1)

    # Print title first
    if 'title' in tiddler:
        print(f"title: {tiddler['title']}")

    # Print all other fields except 'text' and 'title'
    for key, value in sorted(tiddler.items()):
        if key not in ('text', 'title'):
            print(f"{key}: {value}")

    # Print the text content after a newline
    if 'text' in tiddler:
        print()
        print(tiddler['text'])

def main():
    if len(sys.argv) < 2:
        print("Usage: tw <command> [args]", file=sys.stderr)
        print("Commands:", file=sys.stderr)
        print("  ls              List all tiddlers", file=sys.stderr)
        print("  cat <tiddler>   Display tiddler contents", file=sys.stderr)
        sys.exit(1)

    command = sys.argv[1]
    wiki_path = get_wiki_path()

    if command == "ls":
        list_tiddlers(wiki_path)
    elif command == "cat":
        if len(sys.argv) < 3:
            print("Error: cat command requires a tiddler name", file=sys.stderr)
            sys.exit(1)
        tiddler_title = sys.argv[2]
        cat_tiddler(wiki_path, tiddler_title)
    else:
        print(f"Error: Unknown command '{command}'", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
