#!/usr/bin/env python3

import os
import re
import sys

def get_wiki_path():
    wiki_path = os.environ.get('TIDDLYWIKI_WIKI_PATH')

    if not wiki_path:
        print("Error: TIDDLYWIKI_WIKI_PATH environment variable is not set", file=sys.stderr)
        sys.exit(1)

    # Expand ~ to home directory
    wiki_path = os.path.expanduser(wiki_path)

    if not os.path.exists(wiki_path):
        print(f"Error: Wiki path does not exist: {wiki_path}", file=sys.stderr)
        sys.exit(1)

    return wiki_path

def list_tiddlers(wiki_path):
    import json

    with open(wiki_path, 'r', encoding='utf-8') as f:
        content = f.read()

    # Find all tiddlywiki-tiddler-store script tags
    pattern = r'<script class="tiddlywiki-tiddler-store" type="application/json">\s*(\[.*?\])\s*</script>'
    matches = re.finditer(pattern, content, re.DOTALL)

    all_tiddlers = []

    # Collect tiddlers from all stores (earliest to latest)
    for match in matches:
        tiddlers_json = match.group(1)
        tiddlers = json.loads(tiddlers_json)
        all_tiddlers.extend(tiddlers)

    if not all_tiddlers:
        print("Error: Could not find any tiddlers in wiki", file=sys.stderr)
        sys.exit(1)

    # Print all tiddler titles
    for tiddler in all_tiddlers:
        if 'title' in tiddler:
            print(tiddler['title'])

def main():
    if len(sys.argv) < 2:
        print("Usage: tw <command>", file=sys.stderr)
        print("Commands:", file=sys.stderr)
        print("  ls    List all tiddlers", file=sys.stderr)
        sys.exit(1)

    command = sys.argv[1]
    wiki_path = get_wiki_path()

    if command == "ls":
        list_tiddlers(wiki_path)
    else:
        print(f"Error: Unknown command '{command}'", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
