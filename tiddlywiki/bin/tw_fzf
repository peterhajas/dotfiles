#!/bin/bash

# tw_fzf - Interactive TiddlyWiki editor using fzf
#
# Usage: tw_fzf <wiki_path>
#
# Features:
# - Browse and search tiddlers with fzf
# - Preview tiddler contents
# - Edit existing tiddlers or create new ones
# - Uses $EDITOR (or auto-detected editor) for editing

set -e

# Check dependencies
for cmd in fzf tw; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "Error: $cmd is required but not found in PATH" >&2
        exit 1
    fi
done

# Resolve wiki path from argument or environment variable
wiki_path="${1:-}"
if [[ -z "$wiki_path" ]]; then
    echo "Error: wiki path must be provided as an argument" >&2
    exit 1
fi

# Build fzf list and run selection
selected=$(
    {
        echo "[Create New Tiddler]"
        tw "$wiki_path" ls
    } | fzf \
        --preview "tw \"$wiki_path\" cat {} 2>/dev/null || echo \"Enter a title to create a new tiddler\"" \
        --preview-window=right:60%:wrap \
        --prompt="Select tiddler: " \
        --header="Enter to edit, Ctrl-C to cancel"
)

# Handle empty selection (user cancelled)
if [[ -z "$selected" ]]; then
    exit 0
fi

# Handle new tiddler creation
if [[ "$selected" == "[Create New Tiddler]" ]]; then
    read -p "Tiddler title: " title

    # Validate title is not empty
    if [[ -z "$title" ]]; then
        echo "Error: Title cannot be empty" >&2
        exit 1
    fi

    # Create the new tiddler (empty)
    tw "$wiki_path" touch "$title"
else
    title="$selected"
fi

# Edit using tw edit command (uses $EDITOR or auto-detects)
tw "$wiki_path" edit "$title"

echo "Editing complete for: $title"
