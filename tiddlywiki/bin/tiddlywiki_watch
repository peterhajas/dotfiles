#!/bin/bash
# One-shot TiddlyWiki sync - runs on 3-minute interval via LaunchD
# Combines pull and push logic in a single execution

cd ~/phajas-wiki || exit 1

GIT=$(which git)

# Network check function
checkNetwork() {
    ping -c 1 peterhajas.com > /dev/null 2>&1
}

# Exit early if no network
if ! checkNetwork; then
    echo "No network connectivity. Sync skipped."
    exit 0
fi

# Check if there are uncommitted local changes
if [[ -n $($GIT status --porcelain) ]]; then
    # We have local changes - commit and push
    echo "Local changes detected, committing and pushing..."
    $GIT add *
    $GIT commit -a -m "auto commit from macOS"
    $GIT pull --rebase origin master && $GIT push origin master
else
    # No local changes - just pull remote changes
    echo "No local changes, pulling remote updates..."
    $GIT pull --rebase origin master
fi
