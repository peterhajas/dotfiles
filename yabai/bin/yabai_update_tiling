#!/bin/bash

BAR_HEIGHT=0
EDGE_PADDING=14
PADDING=20
WIDGET_PADDING=194
# LEFT_PADDING=86 # width of the $WIDGET_PADDING minus the width the dock takes up on the left
LEFT_PADDING=$EDGE_PADDING

WIDGET_PADDING=$(($WIDGET_PADDING + $EDGE_PADDING))

WIDTH=$(yabai -m query --displays | jq ".[0].frame.w")
LAYOUT="float"

# Set geometry
yabai -m config \
    window_gap $PADDING

# less than 2000 means stack
if awk -v num="$WIDTH" -v comp="2100" 'BEGIN { exit !(num < comp) }'; then
    LAYOUT="stack"
else
    LAYOUT="float"
fi

# back to stack for now
LAYOUT="stack"

# pad for widgets just on the main display's space
yabai -m config --space 1 \
    layout $LAYOUT \
    top_padding 0 \
    bottom_padding 0 \
    left_padding 0 \
    right_padding $WIDGET_PADDING


# don't pad the other displays
for (( i=2; i<=30; i++ ))
do
    yabai -m config --space $i layout "bsp" \
    top_padding 0 \
    bottom_padding 0 \
    left_padding 0 \
    right_padding 0 \
    2>>/dev/null
done

# apply all rules
yabai -m rule --apply

# Function to move windows only if they're not already on the target display
# Args: $1 = target display index, $2+ = window IDs
move_windows_if_needed() {
    local target_display=$1
    shift
    local window_ids=("$@")

    for window_id in "${window_ids[@]}"; do
        local current_display=$(yabai -m query --windows --window $window_id 2>/dev/null | jq -r '.display')
        if [[ -n "$current_display" && "$current_display" != "$target_display" ]]; then
            yabai -m window $window_id --display $target_display 2>/dev/null
        fi
    done
}

# Manage sysmon windows - move to rightmost display and make fullscreen
RIGHTMOST_DISPLAY=$(yabai -m query --displays | jq 'sort_by(.frame.x) | .[-1].index')
NUM_DISPLAYS=$(yabai -m query --displays | jq 'length')

# Only manage special windows if we have more than one display
if [[ $NUM_DISPLAYS -gt 1 ]]; then
    LEFTMOST_DISPLAY=$(yabai -m query --displays | jq 'sort_by(.frame.x) | .[0].index')

    # Find all windows with title exactly "sysmon" (case-insensitive)
    SYSMON_WINDOWS=($(yabai -m query --windows | jq -r '.[] | select(.title | test("^sysmon$"; "i")) | .id'))

    # Move sysmon windows to the rightmost display (only if not already there)
    move_windows_if_needed $RIGHTMOST_DISPLAY "${SYSMON_WINDOWS[@]}"

    # Make each sysmon window fullscreen
    for WINDOW_ID in "${SYSMON_WINDOWS[@]}"; do
        yabai -m window $WINDOW_ID --grid 1:1:0:0:1:1 2>/dev/null
    done

    # Find all Claude/ChatGPT/Codex windows, or titles starting with "claude" or "codex"
    AI_WINDOWS=($(yabai -m query --windows | jq -r '.[] | select(.app == "Claude" or .app == "ChatGPT" or .app == "Codex" or (.title | test("^(claude|codex)"; "i"))) | .id'))

    # Move AI windows to the leftmost display (only if not already there)
    move_windows_if_needed $LEFTMOST_DISPLAY "${AI_WINDOWS[@]}"
fi
