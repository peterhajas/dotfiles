#!/bin/bash
# claudex - Claude Code with Codex backend
# This script makes Claude Code use Codex (OpenAI) as its backend
# Supports multiple concurrent instances via dynamic port allocation

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
INSTANCE_ID=$$

# Function to find a free port
find_free_port() {
  # Start from 3000 and find the first available port
  local port=3000
  while [ $port -lt 3100 ]; do
    if ! lsof -ti:$port > /dev/null 2>&1; then
      echo $port
      return
    fi
    port=$((port + 1))
  done
  echo "3000"  # Fallback
}

# Handle --kill-all flag to clean up stale proxies
if [ "$1" = "--kill-all" ] || [ "$1" = "-K" ]; then
  echo "[Wrapper] Killing all claudex proxies on ports 3000-3099..."
  for port in $(seq 3000 3099); do
    PID=$(lsof -ti:$port 2>/dev/null || true)
    if [ -n "$PID" ]; then
      echo "[Wrapper] Killing process on port $port (PID $PID)"
      echo "$PID" | xargs kill 2>/dev/null || true
    fi
  done
  echo "[Wrapper] Done."
  exit 0
fi

# Find a free port for this instance
PROXY_PORT=$(find_free_port)
LOG_FILE="/tmp/anthropic-codex-proxy-${INSTANCE_ID}.log"

echo "[Wrapper] Instance $INSTANCE_ID using port $PROXY_PORT"

# Interactive model selection (only if no arguments provided)
if [ $# -eq 0 ]; then
  echo "[Wrapper] Select Codex model..."
  CODEX_MODEL=$(echo -e "gpt-5.2-codex (default)|o3|gpt-5.1-codex-max" | \
    ~/dotfiles/hammerspoon/bin/choose | cut -d' ' -f1)

  # Default if user cancelled
  if [ -z "$CODEX_MODEL" ]; then
    CODEX_MODEL="gpt-5.2-codex"
  fi

  echo "[Wrapper] Select reasoning effort..."
  CODEX_REASONING=$(echo -e "medium (default)|low|high" | \
    ~/dotfiles/hammerspoon/bin/choose | cut -d' ' -f1)

  # Default if user cancelled
  if [ -z "$CODEX_REASONING" ]; then
    CODEX_REASONING="medium"
  fi
else
  # Use defaults for non-interactive mode (or respect env vars)
  CODEX_MODEL="${CODEX_MODEL:-gpt-5.2-codex}"
  CODEX_REASONING="${CODEX_REASONING:-medium}"
fi

echo "[Wrapper] Using model: $CODEX_MODEL, reasoning: $CODEX_REASONING"

# Export for proxy and statusline to use
export CODEX_MODEL
export CODEX_REASONING
export PROXY_PORT

# Start Python proxy in background with the allocated port
echo "[Wrapper] Starting Anthropicâ†’Codex proxy on port $PROXY_PORT..."
python3 "$SCRIPT_DIR/anthropic-codex-proxy.py" > "$LOG_FILE" 2>&1 &
PROXY_PID=$!

# Wait for proxy to be ready (check the specific port)
echo "[Wrapper] Waiting for proxy to start..."
PROXY_READY=false
for i in {1..10}; do
  if curl -s "http://localhost:$PROXY_PORT/health" > /dev/null 2>&1; then
    echo "[Wrapper] Proxy ready on port $PROXY_PORT!"
    PROXY_READY=true
    break
  fi
  # Also check if process died
  if ! kill -0 $PROXY_PID 2>/dev/null; then
    echo "[Wrapper] ERROR: Proxy process died. Check logs: $LOG_FILE"
    cat "$LOG_FILE"
    exit 1
  fi
  sleep 0.5
done

if [ "$PROXY_READY" = false ]; then
  echo "[Wrapper] ERROR: Proxy failed to start. Check logs: $LOG_FILE"
  kill $PROXY_PID 2>/dev/null || true
  exit 1
fi

# Create temporary settings with custom statusline
TEMP_SETTINGS="/tmp/claude-codex-settings-${INSTANCE_ID}.json"
cat > "$TEMP_SETTINGS" << EOF
{
  "statusLine": {
    "type": "command",
    "command": "$SCRIPT_DIR/claudex-statusline",
    "padding": 0
  }
}
EOF

# Cleanup function
cleanup() {
  rm -f "$TEMP_SETTINGS"
  rm -f "$LOG_FILE"
  if [ -n "$PROXY_PID" ]; then
    kill $PROXY_PID 2>/dev/null || true
    wait $PROXY_PID 2>/dev/null || true
  fi
}

# Ensure proxy and temp settings are cleaned up on exit
trap cleanup EXIT INT TERM

# Set environment to redirect Claude Code API calls to our proxy
export ANTHROPIC_BASE_URL="http://localhost:$PROXY_PORT"
export ANTHROPIC_API_KEY="codex-backend-dummy-key"

echo "[Wrapper] Launching Claude Code with Codex backend..."
echo "[Wrapper] Check proxy logs: tail -f $LOG_FILE"

# Try to use custom settings if supported, otherwise just launch
if /opt/homebrew/bin/claude --help 2>&1 | grep -q -- "--settings"; then
  /opt/homebrew/bin/claude --settings "$TEMP_SETTINGS" "$@"
else
  # No --settings flag, just launch (statusline won't be custom)
  /opt/homebrew/bin/claude "$@"
fi
