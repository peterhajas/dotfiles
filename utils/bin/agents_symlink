#!/bin/bash

# agents_symlink: Create CLAUDE.md → AGENTS.md symlink
# Usage: agents_symlink [directory]
#
# Creates a CLAUDE.md symlink pointing to AGENTS.md in the specified directory.
# If no directory is specified, uses the current directory.

set -e

DIR="${1:-.}"

cd "$DIR"
FULL_PATH=$(pwd)

# If AGENTS.md is missing but CLAUDE.md exists, offer to flip it.
if [ ! -e "AGENTS.md" ] && [ -e "CLAUDE.md" ]; then
    echo "Warning: AGENTS.md not found, but CLAUDE.md exists in $FULL_PATH"
    read -p "Create AGENTS.md from CLAUDE.md and link CLAUDE.md → AGENTS.md? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted"
        exit 1
    fi
    if [ -L "CLAUDE.md" ] && [ "$(readlink "CLAUDE.md")" = "AGENTS.md" ]; then
        echo "Error: CLAUDE.md points to missing AGENTS.md in $FULL_PATH"
        exit 1
    fi
    if [ -L "CLAUDE.md" ]; then
        cp -p "CLAUDE.md" "AGENTS.md"
        rm "CLAUDE.md"
    else
        mv "CLAUDE.md" "AGENTS.md"
    fi
    ln -s AGENTS.md CLAUDE.md
    echo "✓ Fixed: AGENTS.md is now the real file in $FULL_PATH"
    exit 0
fi

# If AGENTS.md is a symlink back to CLAUDE.md, fix the direction.
if [ -L "AGENTS.md" ] && [ "$(readlink "AGENTS.md")" = "CLAUDE.md" ]; then
    echo "Warning: AGENTS.md is a symlink to CLAUDE.md in $FULL_PATH"
    read -p "Fix by making AGENTS.md the real file and linking CLAUDE.md → AGENTS.md? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted"
        exit 1
    fi
    if [ -L "CLAUDE.md" ] && [ "$(readlink "CLAUDE.md")" = "AGENTS.md" ]; then
        echo "Error: CLAUDE.md is also a symlink to AGENTS.md in $FULL_PATH"
        exit 1
    fi
    rm "AGENTS.md"
    if [ -L "CLAUDE.md" ]; then
        cp -p "CLAUDE.md" "AGENTS.md"
        rm "CLAUDE.md"
    else
        mv "CLAUDE.md" "AGENTS.md"
    fi
    ln -s AGENTS.md CLAUDE.md
    echo "✓ Fixed: AGENTS.md is now the real file in $FULL_PATH"
    exit 0
fi

# Check if AGENTS.md exists
if [ ! -f "AGENTS.md" ]; then
    echo "Error: AGENTS.md not found in $FULL_PATH"
    exit 1
fi

# Check if CLAUDE.md already exists
if [ -e "CLAUDE.md" ]; then
    # Check if it's already a symlink to AGENTS.md
    if [ -L "CLAUDE.md" ]; then
        TARGET=$(readlink "CLAUDE.md")
        if [ "$TARGET" = "AGENTS.md" ]; then
            echo "✓ CLAUDE.md → AGENTS.md symlink already exists in $FULL_PATH"
            exit 0
        else
            echo "Warning: CLAUDE.md is a symlink to '$TARGET', not AGENTS.md"
            read -p "Replace with AGENTS.md symlink? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Aborted"
                exit 1
            fi
            rm "CLAUDE.md"
        fi
    else
        echo "Error: CLAUDE.md exists and is not a symlink in $FULL_PATH"
        echo "Please remove or rename it manually before running this script"
        exit 1
    fi
fi

# Create the symlink
ln -s AGENTS.md CLAUDE.md
echo "✓ Created CLAUDE.md → AGENTS.md symlink in $FULL_PATH"
