#!/usr/bin/env bash
# macOS xdg-open wrapper with special file handling
# On Linux, delegates to real xdg-open

set -euo pipefail

# On Linux, delegate to real xdg-open
if [[ "$(uname)" != "Darwin" ]]; then
    exec /usr/bin/xdg-open "$@"
fi

# Parse flags
background=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        -g|--background)
            background="-g"
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    echo "Usage: xdg-open [-g] <file>" >&2
    exit 1
fi

file="$1"

# Get extension (lowercase)
ext="${file##*.}"
ext="$(echo "$ext" | tr '[:upper:]' '[:lower:]')"

# Temp file base: deterministic if background mode (for reuse), random otherwise
if [[ -n "$background" ]]; then
    # Deterministic path based on file's realpath
    realpath="$(cd "$(dirname "$file")" && pwd)/$(basename "$file")"
    hash="$(echo -n "$realpath" | md5)"
    tmpbase="/tmp/xdg-preview-${hash}"
else
    tmpbase="/tmp/xdg-open-$(date +%s)-$$"
fi

# Helper: close Safari tab matching a file URL
close_safari_tab() {
    local url="$1"
    [[ -z "$background" ]] && return
    osascript -e "
        try
            tell application \"Safari\"
                repeat with w in every window
                    repeat with t in every tab of w
                        if URL of t starts with \"$url\" then
                            close t
                        end if
                    end repeat
                end repeat
            end tell
        end try
    " 2>/dev/null || true
}

# Helper: close Preview window matching a filename
close_preview_window() {
    local name="$1"
    osascript -e "
        tell application \"Preview\"
            repeat with w in every window
                if name of w contains \"$name\" then
                    close w
                end if
            end repeat
        end tell
    " 2>/dev/null || true
}

# Get absolute path for file URL
file_abs="$(cd "$(dirname "$file")" && pwd)/$(basename "$file")"

case "$ext" in
    md)
        # Markdown → HTML → open in browser
        tmp="${tmpbase}.html"
        close_safari_tab "file://${tmp}"

        # Convert markdown to HTML with proper encoding and dark mode support
        {
            cat <<'HTMLHEAD'
<!DOCTYPE html><html><head><meta charset="utf-8"><style>
:root { color-scheme: light dark; }
body {
    font-family: system-ui;
    max-width: 800px;
    margin: 40px auto;
    padding: 0 20px;
    line-height: 1.6;
}
pre, code { padding: 2px 5px; border-radius: 4px; }
pre { padding: 10px; overflow-x: auto; }
@media (prefers-color-scheme: light) {
    body { background: #fff; color: #222; }
    pre, code { background: #f4f4f4; }
    a { color: #0066cc; }
}
@media (prefers-color-scheme: dark) {
    body { background: #1a1a1a; color: #e0e0e0; }
    pre, code { background: #2d2d2d; }
    a { color: #6db3f2; }
}
</style></head><body>
HTMLHEAD
            if command -v multimarkdown &>/dev/null; then
                multimarkdown "$file"
            elif command -v pandoc &>/dev/null; then
                pandoc "$file"
            else
                cat "$file"
            fi
            echo '</body></html>'
        } > "$tmp"

        open $background "$tmp"
        ;;

    scad)
        # OpenSCAD → USDZ (with color support) → Preview.app
        usdz="${tmpbase}.usdz"
        close_preview_window "$(basename "$usdz")"
        scad2usdz "$file" "$usdz"
        open $background -a Preview "$usdz"
        ;;

    *)
        # Default: close Safari tab if exists, then open
        close_safari_tab "file://${file_abs}"
        open $background "$file"
        ;;
esac
