---
- name: Configure Podman storage driver and user namespaces
  hosts: torch
  tasks:
    - name: Check if phajas has subuid entry
      become: yes
      command: grep -q "^phajas:" /etc/subuid
      register: subuid_exists
      failed_when: false
      changed_when: false

    - name: Add subuid range for phajas
      become: yes
      lineinfile:
        path: /etc/subuid
        line: "phajas:100000:65536"
        create: yes
      when: subuid_exists.rc != 0

    - name: Check if phajas has subgid entry
      become: yes
      command: grep -q "^phajas:" /etc/subgid
      register: subgid_exists
      failed_when: false
      changed_when: false

    - name: Add subgid range for phajas
      become: yes
      lineinfile:
        path: /etc/subgid
        line: "phajas:100000:65536"
        create: yes
      when: subgid_exists.rc != 0

    - name: Create containers config directory
      become: false
      file:
        path: /home/phajas/.config/containers
        state: directory

    - name: Stop all containers (if any)
      become: false
      command: podman stop --all
      failed_when: false
      changed_when: false

    - name: Remove all containers (if any)
      become: false
      command: podman rm --all
      failed_when: false
      changed_when: false

    - name: Reset podman storage
      become: false
      command: podman system reset --force
      changed_when: true

    - name: Configure storage.conf to use overlay
      become: false
      copy:
        dest: /home/phajas/.config/containers/storage.conf
        content: |
          [storage]
          driver = "overlay"

    - name: Run podman system migrate
      become: false
      command: podman system migrate
      changed_when: true

    - name: Verify storage driver
      become: false
      shell: podman info --format '{{"{{"}} .Store.GraphDriverName {{"}}"}}'
      register: storage_driver
      changed_when: false

    - name: Display storage driver
      debug:
        msg: "Storage driver is now: {{ storage_driver.stdout }}"

    - name: Enable Podman API socket
      become: false
      ansible.builtin.systemd:
        name: podman.socket
        enabled: yes
        state: started
        scope: user
        daemon_reload: yes

    - name: Verify Podman socket is running
      become: false
      ansible.builtin.systemd:
        name: podman.socket
        state: started
        scope: user
